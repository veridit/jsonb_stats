BEGIN;
CREATE EXTENSION jsonb_stats;
-- Test Setup
-- The legal_unit table tracks companies and their validity periods.
CREATE TABLE legal_unit (
    legal_unit_id INT,
    name TEXT,
    region TEXT,
    valid_from DATE NOT NULL,
    valid_until DATE NOT NULL
);
INSERT INTO legal_unit (legal_unit_id, name, region, valid_from, valid_until) VALUES
(1, 'Company A', 'EU', '2023-01-01', '2024-01-01'),
(2, 'Company B', 'US', '2023-01-01', '2024-01-01'),
(3, 'Company C', 'EU', '2023-01-01', '2024-01-01'),
(1, 'Company A Rev.', 'EU', '2024-01-01', 'infinity'); -- Company A was revised for the next period
-- The stat_for_unit table holds raw statistical data.
CREATE TABLE stat_for_unit (
    legal_unit_id INT,
    code TEXT,
    value_int INT,
    value_bool BOOLEAN,
    value_text TEXT,
    value_date DATE,
    stat JSONB GENERATED ALWAYS AS (
        CASE
            WHEN value_int IS NOT NULL THEN stat(value_int)
            WHEN value_bool IS NOT NULL THEN stat(value_bool)
            WHEN value_text IS NOT NULL THEN stat(value_text)
            WHEN value_date IS NOT NULL THEN stat(value_date)
        END
    ) STORED,
    CONSTRAINT one_value_must_be_set CHECK (
        (value_int IS NOT NULL)::int +
        (value_bool IS NOT NULL)::int +
        (value_text IS NOT NULL)::int +
        (value_date IS NOT NULL)::int = 1
    )
);
-- Populate with data for the 2023 period
INSERT INTO stat_for_unit (legal_unit_id, code, value_int, value_bool, value_text) VALUES
(1, 'num_employees', 150, NULL, NULL),
(1, 'is_profitable', NULL, true, NULL),
(1, 'industry', NULL, NULL, 'tech'),
(2, 'num_employees', 2500, NULL, NULL),
(2, 'is_profitable', NULL, true, NULL),
(2, 'industry', NULL, NULL, 'finance'),
(3, 'num_employees', 50, NULL, NULL),
(3, 'is_profitable', NULL, false, NULL),
(3, 'industry', NULL, NULL, 'tech');
-- Test cases
-- Show results suitable for jsonb_pretty for easy diffing.
\t
\a
\x
-- Test Level 1: stat -> stats
-- Create `stats` for each legal unit.
WITH legal_unit_history AS (
    SELECT
        lu.legal_unit_id,
        (
            SELECT jsonb_stats_agg(sfu.code, sfu.stat)
            FROM stat_for_unit sfu
            WHERE sfu.legal_unit_id = lu.legal_unit_id
        ) AS stats
    FROM
        legal_unit lu
    WHERE lu.valid_from = '2023-01-01'
)
SELECT legal_unit_id, jsonb_pretty(stats) as stats
FROM legal_unit_history
ORDER BY legal_unit_id;
legal_unit_id|1
stats|{
    "industry": {
        "type": "text",
        "value": "tech"
    },
    "is_profitable": {
        "type": "boolean",
        "value": true
    },
    "num_employees": {
        "type": "integer",
        "value": 150
    }
}

legal_unit_id|2
stats|{
    "industry": {
        "type": "text",
        "value": "finance"
    },
    "is_profitable": {
        "type": "boolean",
        "value": true
    },
    "num_employees": {
        "type": "integer",
        "value": 2500
    }
}

legal_unit_id|3
stats|{
    "industry": {
        "type": "text",
        "value": "tech"
    },
    "is_profitable": {
        "type": "boolean",
        "value": false
    },
    "num_employees": {
        "type": "integer",
        "value": 50
    }
}
-- Test Level 2: stats -> stats_summary
-- Create `stats_summary` for each region.
WITH legal_unit_history AS (
    SELECT
        lu.legal_unit_id,
        lu.region,
        (
            SELECT jsonb_stats_agg(sfu.code, sfu.stat)
            FROM stat_for_unit sfu
            WHERE sfu.legal_unit_id = lu.legal_unit_id
        ) AS stats
    FROM
        legal_unit lu
    WHERE lu.valid_from = '2023-01-01'
),
history_facet AS (
    SELECT
        luh.region,
        jsonb_stats_summary_agg(luh.stats) as stats_summary
    FROM legal_unit_history luh
    GROUP BY luh.region
)
SELECT region, jsonb_pretty(stats_summary) as stats_summary
FROM history_facet
ORDER BY region;
region|EU
stats_summary|{
    "industry": {
        "type": "text_summary",
        "counts": {
            "tech": 2
        }
    },
    "is_profitable": {
        "type": "boolean_summary",
        "counts": {
            "true": 1,
            "false": 1
        }
    },
    "num_employees": {
        "max": 150,
        "min": 50,
        "sum": 200,
        "mean": 100.00,
        "type": "integer_summary",
        "count": 2,
        "stddev": 70.71,
        "variance": 5000.00,
        "sum_sq_diff": 5000.00,
        "coefficient_of_variation_pct": 70.71
    }
}

region|US
stats_summary|{
    "industry": {
        "type": "text_summary",
        "counts": {
            "finance": 1
        }
    },
    "is_profitable": {
        "type": "boolean_summary",
        "counts": {
            "true": 1
        }
    },
    "num_employees": {
        "max": 2500,
        "min": 2500,
        "sum": 2500,
        "mean": 2500.00,
        "type": "integer_summary",
        "count": 1,
        "stddev": null,
        "variance": null,
        "sum_sq_diff": 0.00,
        "coefficient_of_variation_pct": null
    }
}
-- Test Level 3: stats_summary -> stats_summary
-- Combine regional summaries into a global summary.
WITH legal_unit_history AS (
    SELECT
        lu.legal_unit_id,
        lu.region,
        (
            SELECT jsonb_stats_agg(sfu.code, sfu.stat)
            FROM stat_for_unit sfu
            WHERE sfu.legal_unit_id = lu.legal_unit_id
        ) AS stats
    FROM
        legal_unit lu
    WHERE lu.valid_from = '2023-01-01'
),
history_facet AS (
    SELECT
        luh.region,
        jsonb_stats_summary_agg(luh.stats) as stats_summary
    FROM legal_unit_history luh
    GROUP BY luh.region
),
history AS (
    SELECT
        jsonb_stats_summary_merge_agg(hf.stats_summary) as stats_summary
    FROM history_facet hf
)
SELECT jsonb_pretty(stats_summary) as stats_summary
FROM history;
stats_summary|{
    "industry": {
        "type": "text_summary",
        "counts": {
            "tech": 2,
            "finance": 1
        }
    },
    "is_profitable": {
        "type": "boolean_summary",
        "counts": {
            "true": 2,
            "false": 1
        }
    },
    "num_employees": {
        "max": 2500,
        "min": 50,
        "sum": 2700,
        "mean": 900.00,
        "type": "integer_summary",
        "count": 3,
        "stddev": 1386.54,
        "variance": 1922500.00,
        "sum_sq_diff": 3845000.00,
        "coefficient_of_variation_pct": 154.06
    }
}
ROLLBACK;
